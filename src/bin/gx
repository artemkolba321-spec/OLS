#!/usr/bin/env bash
# OLS command: gx
# Git eXec â€” clone GitHub repo and enter its directory

set -euo pipefail
IFS=$'\n\t'

# ===== Paths =====
OLS_DIR="$HOME/OLS"
LOG_FILE="$OLS_DIR/logs.log"

# ===== Logging =====
ols_log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') [OLS][gx] $@" >> "$LOG_FILE"
}

die() {
    echo "gx: $@" >&2
    ols_log "EE: $@"
    exit 1
}

# ===== Help =====
gx_help() {
    cat <<'EOF'
gx - Git eXec

usage:
    gx <user>/<repo>
    gx <HTTPS>
description:
    Clones a GitHub repository
    and automatically enters its directory.
options:
    --help      Show this help message and exit.
examples:
    gx torvalds/linux
    gx https://github.com/artemkolba321-spec/ols-repo.git
EOF
}

# ===== Args =====
if [[ $# -eq 0 ]]; then
    gx_help
    exit 0
fi

if [[ "$1" == "--help" ]]; then
    gx_help
    exit 0
fi

# ===== Check git =====
command -v git >/dev/null 2>&1 || die "git not found"

# ===== Main =====
repo="$1"

# Determine URL and directory name
if [[ "$repo" =~ ^https://github.com/ ]]; then
    url="$repo"
    dir="$(basename "$repo" .git)"
else
    url="https://github.com/$repo.git"
    dir="$(basename "$repo")"
fi

# If directory exists, just enter it
if [[ -d "$dir" ]]; then
    cd "$dir" || die "Cannot enter directory $dir"
    ols_log "Entered existing repository $dir"
    exit 0
fi

# Clone repository
git clone "$url" || die "Failed to clone $url"
cd "$dir" || die "Failed to enter directory $dir"
ols_log "Cloned and entered repository $dir"
