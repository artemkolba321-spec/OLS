#!/usr/bin/env bash
# OLS command: gx

set -euo pipefail
IFS=$'\n\t'

# ===== logging =====
OLS_DIR="$HOME/OLS"
LOG_FILE="$OLS_DIR/logs.ols"

ols_log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') [OLS][gx] $@" >> "$LOG_FILE"
}

die() {
    echo "gx: $@" >&2
    ols_log "EE: $@"
    exit 1
}

# ===== Help =====
if [[ $# -eq 0 || "$1" == "--help" ]]; then
    cat <<EOF
gx - Git exec (clone wrapper)

usage:
    gx <user>/<repo>       (GitHub username/repo)
    gx <HTTPS>             (https://github.com/user/repo.git)
    gx <SSH>               (git@github.com:user/repo.git)

description:
    Clones a GitHub repository. DOES NOT change directory.
EOF
    exit 0
fi

command -v git >/dev/null 2>&1 || die "Git not found"

# ===== Main =====
repo="$1"

# Determine URL and directory name
if [[ "$repo" =~ ^https://github.com/ ]]; then
    url="$repo"
    dir="$(basename "$repo" .git)"
elif [[ "$repo" =~ ^git@github.com: ]]; then
    url="$repo"
    dir="$(basename "$repo" .git)"
else
    url="https://github.com/$repo.git"
    dir="$(basename "$repo")"
fi

# If directory exists, skip cloning
if [[ -d "$dir" ]]; then
    echo "gx: directory '$dir' already exists, skipping clone"
    ols_log "Skip clone: $dir exists"
    exit 0
fi

# Clone repository
git clone "$url" "$dir" || die "failed to clone $url"
echo "gx: cloned repository '$dir'"
ols_log "Cloned repository $dir"
