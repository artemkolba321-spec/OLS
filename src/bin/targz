#!/usr/bin/env bash
# OLS command: targz (minimal flags, -x for extract)

set -euo pipefail
IFS=$'\n\t'

# ===== Paths =====
OLS_DIR="$HOME/OLS"
LOG_FILE="$OLS_DIR/logs.log"

# ===== Logging =====
ols_log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') [OLS][targz] $@" >> "$LOG_FILE"
}

die() {
    echo "targz: $@" >&2
    ols_log "EE: $@"
    exit 1
}

# ===== Help =====
show_help() {
    cat <<'EOF'
targz - create or extract .tar.gz archives

Usage:
    targz <file_or_dir>... [-o <archive_name.tar.gz>]   # create archive
    targz -x <archive.tar.gz>                           # extract archive

Options:
    -o <archive_name>   Specify output archive name (creation only)
    -x                  Extract archive
    --help              Show this help message

Behavior:
    - No flags → create archive from given files/directories
    - -x → extract archive into folder with archive name
EOF
}

# ===== Args =====
[[ $# -eq 0 ]] && show_help && exit 0
if [[ "$1" == "--help" ]]; then
    show_help
    exit 0
fi

# ===== Check tar =====
command -v tar >/dev/null 2>&1 || die "tar command not found"

# ===== Parse arguments =====
MODE="create"
OUTPUT=""
FILES=()

while [[ $# -gt 0 ]]; do
    case "$1" in
        -o)
            shift
            [[ $# -eq 0 ]] && die "Missing archive name after -o"
            OUTPUT="$1"
            ;;
        -x)
            MODE="extract"
            shift
            [[ $# -eq 0 ]] && die "Missing archive file to extract after -x"
            FILES+=("$1")
            ;;
        *)
            FILES+=("$1")
            ;;
    esac
    shift
done

# ===== Execute =====
if [[ "$MODE" == "create" ]]; then
    [[ ${#FILES[@]} -gt 0 ]] || die "No files or directories specified to archive"
    [[ -z "$OUTPUT" ]] && OUTPUT="${FILES[0]}.tar.gz"
    tar -czf "$OUTPUT" "${FILES[@]}" || die "Failed to create archive $OUTPUT"
    ols_log "Created archive $OUTPUT from: ${FILES[*]}"
    echo "Archive created: $OUTPUT"
else
    ARCHIVE="${FILES[0]}"
    [[ -f "$ARCHIVE" ]] || die "Archive file $ARCHIVE not found"
    DIR_NAME="$(basename "$ARCHIVE" .tar.gz)"
    mkdir -p "$DIR_NAME"
    tar -xzf "$ARCHIVE" -C "$DIR_NAME" || die "Failed to extract $ARCHIVE"
    ols_log "Extracted archive $ARCHIVE into $DIR_NAME"
    echo "Archive extracted into: $DIR_NAME"
fi
