#!/usr/bin/env bash
# OLS command: olsp
# Handles plugin creation, build, installation, and listing

set -euo pipefail
IFS=$'\n\t'

source "$HOME/OLS/lib/env.sh"

# ===== Ensure plugins dir exists =====
mkdir -p "$PLUGINS_DIR"

# ===== Main =====
case "${1-}" in
    init)
        if [[ -n "${2-}" ]]; then
            PLUGIN_NAME="$2"
            [[ -d "$PLUGIN_NAME" ]] && warn "Directory '$PLUGIN_NAME' already exists"
            mkdir "$PLUGIN_NAME"
            cd "$PLUGIN_NAME"
        else
            PLUGIN_NAME="$(basename "$PWD")"
        fi
        # create package.json
        cat > package.json <<EOF
{
  "name": "$PLUGIN_NAME",
  "version": "0.1.0",
  "author": "$USER"
}
EOF

        SECRET="OLS-$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 30)-d"
        PUB="$(head /dev/urandom | tr -dc 0-9 | head -c 10)"
        
        mkdir keys
        touch keys/$PLUGIN_NAME.pub
        touch keys/$PLUGIN_NAME.key
        
        echo "$PUB" > "keys/$PLUGIN_NAME.pub"
        echo "$SECRET" > "keys/$PLUGIN_NAME.key"

        cat > .gitignore <<EOF
keys/$PLUGIN_NAME.key
EOF
        

        # create template plugin.lua
        cat > plugin.lua <<'EOF'
print("Hello from plugin!")
EOF

        chmod 644 package.json plugin.lua
        mkdir files

        echo "Plugin '$PLUGIN_NAME' initialized successfully!"
        ;;
    keygen)
        PLUGIN_PATH="${2-}"
        if [[ -z "$PLUGIN_PATH" ]]; then
            PLUGIN_PATH="$PWD"
        fi
        [[ ! -f "package.json" ]] && ee "package.json not found"


        PLUGIN_PATH="$(realpath -m "$PLUGIN_PATH")"

        [[ ! -d "$PLUGIN_PATH" ]] && warn "Plugin not found: $PLUGIN_PATH"

        PLUGIN_NAME="$(basename "$PLUGIN_PATH")"
        KEY_DIR="$PLUGIN_PATH/keys"
        KEY_FILE="$KEY_DIR/$PLUGIN_NAME.key"
        PUB_FILE="$KEY_DIR/$PLUGIN_NAME.pub"

        mkdir -p "$KEY_DIR"

        if [[ ! -f "$PUB_FILE" ]]; then
            PUB="$(head /dev/urandom | tr -dc 0-9 | head -c 10)"
            echo "$PUB" > "$PUB_FILE"
            echo "Public key generated: $PUB_FILE"
        else
            echo "Public key exists: $PUB_FILE"
        fi

        if [[ ! -f "$KEY_FILE" ]]; then
            SECRET="OLS-$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 30)-d"
            echo "$SECRET" > "$KEY_FILE"
            echo "Secret key generated: $KEY_FILE"
        else
            echo "Secret key exists: $KEY_FILE"
        fi

        info "Keys updated for plugin: $PLUGIN_PATH"
        ;;
    build)
        PLUGIN_DIR="${2-}"
        [[ -z "$PLUGIN_DIR" ]] && warn "Usage: olsp build <plugin-dir>"
        [[ ! -d "$PLUGIN_DIR" ]] && warn "Plugin directory not found"
        [[ ! -f "package.json" ]] && ee "package.json not found"
        PLUGIN_NAME="$(basename "$PLUGIN_DIR")"
        PARENT_DIR="$(dirname "$PLUGIN_DIR")"

        # Archive plugin directory with correct structure
        tar -czf "$PLUGIN_NAME.olsp" -C "$PARENT_DIR" "$PLUGIN_NAME"

        echo "Plugin built: $PLUGIN_NAME.olsp"
        info "Built plugin: $PLUGIN_NAME"
        ;;


    install)
        PACKAGE_FILE="${2-}"
        [[ -z "$PACKAGE_FILE" ]] && warn "Usage: olsp install <package.olsp>"
        [[ ! -f "$PACKAGE_FILE" ]] && warn "File not found: $PACKAGE_FILE"

        

        # get plugin name from archive
        PLUGIN_NAME="$(basename "$PACKAGE_FILE" .olsp)"
        TARGET_DIR="$PLUGINS_DIR/$PLUGIN_NAME"

        # clean old installation if exists
        [[ -d "$TARGET_DIR" ]] && rm -rf "$TARGET_DIR"

        # extract archive
        mkdir -p "$TARGET_DIR"
        tar -xzf "$PACKAGE_FILE" -C "$PLUGINS_DIR"

        KEY_FILE="$TARGET_DIR/keys/$PLUGIN_NAME.key"
        PUB_FILE="$TARGET_DIR/keys/$PLUGIN_NAME.pub"

        if [[ ! -f "$KEY_FILE" || ! -f "$PUB_FILE" ]]; then
            echo "Package is missing keys."
            [[ ! -f "$KEY_FILE" ]] && echo "  - secret key (.key) not found"
            [[ ! -f "$PUB_FILE" ]] && echo "  - public key (.pub) not found"
            echo "It is not recommended to download this package."
            printf "Do you really want to install this package? (y/N)"
            read -r answer
            if [[ "$answer" != "y" && "$answer" != "Y" ]]; then
                echo "Installation cancelled"
                rm -rf "$TARGET_DIR"
                exit 1
            fi
        else
            echo "Both keys found. Package trusted."
        fi

        # validate package.json
        [[ ! -f "$TARGET_DIR/package.json" ]] &&  "package.json not found in package"

        echo "Plugin '$PLUGIN_NAME' installed to $PLUGINS_DIR"
        info "Installed plugin: $PLUGIN_NAME"
        ;;
    uninstall)
        PLUGIN_NAME="${2-}"
        [[ -z "$PLUGIN_NAME" ]] && warn "Usage: olsp uninstall <plugin-name>"
        TARGET_DIR="$PLUGINS_DIR/$PLUGIN_NAME"
        [[ ! -d "$TARGET_DIR" ]] && warn "Plugin not found"
        rm -rf "$TARGET_DIR"
        echo "Plugin '$PLUGIN_NAME' removed"
        info "Uninstalled plugin: $PLUGIN_NAME"
        ;;
    list)
        echo "Installed plugins:"
        ls -1 "$PLUGINS_DIR"
        ;;

    *)
        info "Unknown command: $1"
        ;;
esac
