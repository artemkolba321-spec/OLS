#!/usr/bin/env bash
# Open Linux Shell (OLS)

set -u
IFS=$'\n\t'

source "$HOME/OLS/lib/env.sh"

# ===== Help =====
show_help() {
    cat <<'EOF'
Open Linux Shell (OLS)

usage:
    ols              - start interactive shell
    ols --help       - show this help
    ols doctor       - run diagnostics
    ols update       - update OLS from git repository

interactive:
    help             - show this help
    exit             - exit OLS
    PATH             - show PATH or OLS tree
    doctor           - run diagnostics
    <command> [args] - run system command
EOF
}

# ===== Doctor =====
ols_doctor() {
    echo "OLS Doctor report"
    echo "------------------"

    # ===== Counters =====
    ok_count=0
    warn_count=0
    fail_count=0

    # ===== Checked paths to avoid duplicates =====
    declare -A checked

    # ===== Universal check function =====
    check() {
        local type="$1"
        local target="$2"

        # empty target
        [[ -z "$target" ]] && { echo "[WARN] Empty target for type: $type"; ((warn_count++)); return; }

        # normalize path for dirs/files
        if [[ "$type" == "dir" || "$type" == "file" ]]; then
            target=$(realpath -m "$target")
        fi

        # skip if already checked
        [[ -n "${checked[$target]+_}" ]] && return
        checked[$target]=1

        # ===== Check by type =====
        case "$type" in
            dir)
                if [[ -d "$target" ]]; then
                    echo "[OK]     Directory: $target"
                    ((ok_count++))
                else
                    echo "[FAIL]   Directory missing: $target"
                    ((fail_count++))
                fi
                ;;
            file)
                if [[ -f "$target" ]]; then
                    echo "[OK]     File: $target"
                    ((ok_count++))
                else
                    echo "[FAIL]   File missing: $target"
                    ((fail_count++))
                fi
                ;;
            cmd)
                if command -v "$target" >/dev/null 2>&1; then
                    echo "[OK]     Command: $target"
                    ((ok_count++))
                else
                    echo "[FAIL]   Command missing: $target"
                    ((fail_count++))
                fi
                ;;
            *)
                echo "[WARN] Unknown check type: $type"
                ((warn_count++))
                ;;
        esac
    }

    # ===== Paths & dependencies =====
    OLS_DIR="${OLS_DIR:-$HOME/OLS}"
    BIN_DIR="${BIN_DIR:-$OLS_DIR/bin}"
    LOG_FILE="${LOG_FILE:-$OLS_DIR/logs.log}"

    SYSTEM_DIRS=("$OLS_DIR" "$BIN_DIR")
    SYSTEM_FILES=("$LOG_FILE" "$HOME/.olsrc")
    DEPENDENCIES=(git wget bash tree lua jq) 

    # ===== Check directories =====
    for dir in "${SYSTEM_DIRS[@]}"; do
        check dir "$dir"
    done

    # ===== Check files =====
    for file in "${SYSTEM_FILES[@]}"; do
        check file "$file"
    done

    # ===== Check commands =====
    for cmd in "${DEPENDENCIES[@]}"; do
        check cmd "$cmd"
    done

    # ===== Summary =====
    echo
    echo "Summary:"
    echo "  OK: $ok_count"
    echo "  WARN: $warn_count"
    echo "  FAIL: $fail_count"
}

# ===== Interactive shell =====
interactive_shell() {
    info "Interactive shell started"
    echo "Welcome to OLS! (help — show help, exit — quit)"

    while true; do
        DIR=$(basename "$PWD")
        OLD_IFS="$IFS"
        IFS=' ' read -rp "ols-$DIR> " -a input_words || break
        IFS="$OLD_IFS"

        cmd="${input_words[0]-}"
        args=("${input_words[@]:1}")
        case "$cmd" in
            exit)
                info "Shell exited"
                echo "Goodbye!"
                break
                ;;
            help)
                show_help
                ;;
            PATH)
                case "${args[0]-}" in
                    OLS)
                        tree "$OLS_DIR"
                        ;;
                    *)
                        echo "$PATH"
                        ;;
                esac
                ;;
            doctor)
                ols_doctor
                ;;
            "")
                ;;
            *)
                PLUGIN_DIR="$OLS_DIR/plugins/$cmd"
                PLUGIN_MAIN="$PLUGIN_DIR/plugin.lua"

                if [[ -f "$PLUGIN_MAIN" ]]; then
                    lua "$PLUGIN_MAIN" "${args[@]}"
                    continue
                fi
                
                # If not a plugin, try system command
                if command -v "$cmd" >/dev/null 2>&1; then
                    "$cmd" "${args[@]-}"
                    continue
                fi

                echo "Unknown command: $cmd"
                ee "Unknown command: $cmd"
                ;;
        esac
    done
}


# ===== Main =====
case "${1-}" in
    --help)
        show_help
        ;;
    --version)
        echo "$OLS_VERSION"
        ;;
    doctor)
        ols_doctor
        ;;
    "")
        interactive_shell
        ;;
    *.ols)
        FILE="$1"
        shift || true

        # Normalize path
        if [[ "$FILE" != /* ]]; then
            FILE="$(realpath "$FILE")"
        fi

        [[ ! -f "$FILE" ]] && die "File not found: $FILE"

        bash "$FILE" "$@"
        ;;
    *)
        ee "Unknown command: $1"
        ;;
esac

